# Резюме

Ця загроза впливає на всі додатки, які взаємодіють з поштовими серверами (IMAP/SMTP), загалом на веб-поштові додатки. Метою цього тесту є перевірка можливості впровадження довільних команд IMAP/SMTP у поштові сервери через неналежну санітизацію вхідних даних.

Техніка IMAP/SMTP ін'єкції є більш ефективною, якщо поштовий сервер не доступний безпосередньо з Інтернету. Якщо можлива повна комунікація з бекенд поштовим сервером, рекомендується проводити пряме тестування.

IMAP/SMTP ін'єкція дозволяє отримати доступ до поштового сервера, який в іншому випадку не був би безпосередньо доступний з Інтернету. У деяких випадках ці внутрішні системи не мають того ж рівня інфраструктурної безпеки та захисту, що застосовується до фронтенд веб-серверів. Тому результати поштового сервера можуть бути більш вразливими до атак кінцевих користувачів (див. схему, представлену на Рисунку 1).

Рисунок 1 зображує потік трафіку, який зазвичай спостерігається при використанні технологій веб-пошти. Кроки 1 і 2 - це взаємодія користувача з клієнтом веб-пошти, тоді як крок 2 - це тестувальник, який обходить клієнт веб-пошти та взаємодіє безпосередньо з бекенд поштовими серверами.

Ця техніка дозволяє широкий спектр дій та атак. Можливості залежать від типу та обсягу ін'єкції та технології поштового сервера, що тестується.

Деякі приклади атак з використанням техніки IMAP/SMTP ін'єкції:

- Експлуатація вразливостей у протоколі IMAP/SMTP
- Обхід обмежень додатка
- Обхід процесів анти-автоматизації
- Витоки інформації
- Relay/SPAM

## Цілі тестування
- Ідентифікувати точки IMAP/SMTP ін'єкцій
- Зрозуміти потік даних та структуру розгортання системи
- Оцінити вплив ін'єкції

## Як тестувати

### Ідентифікація вразливих параметрів

Для виявлення вразливих параметрів тестувальник повинен проаналізувати здатність додатка обробляти вхідні дані. Тестування валідації вхідних даних вимагає від тестувальника відправлення фіктивних або зловмисних запитів на сервер та аналізу відповіді. У безпечному додатку відповіддю має бути помилка з відповідною дією, що повідомляє клієнту про те, що щось пішло не так. У вразливому додатку зловмисний запит може бути оброблений бекенд додатком, який відповість повідомленням HTTP 200 OK.

Важливо відзначити, що запити, які надсилаються, повинні відповідати технології, що тестується. Надсилання рядків SQL-ін'єкції для Microsoft SQL Server, коли використовується сервер MySQL, призведе до хибнопозитивних відповідей. У цьому випадку надсилання зловмисних команд IMAP є modus operandi, оскільки IMAP є базовим протоколом, що тестується.

Спеціальні параметри IMAP, які слід використовувати:

| На сервері IMAP | На сервері SMTP |
|-----------------|-----------------|
| Автентифікація | Email відправника |
| Операції з поштовими скриньками (список, читання, створення, видалення, перейменування) | Email одержувача |
| Операції з повідомленнями (читання, копіювання, переміщення, видалення) | Тема |
| Від'єднання | Тіло повідомлення |
| | Прикріплені файли |

У цьому прикладі параметр "mailbox" тестується шляхом маніпулювання всіма запитами з параметром у:

```
http://<webmail>/src/read_body.php?mailbox=INBOX&passed_id=46106&startMessage=1
```

Можуть використовуватися наступні приклади:

Призначити нульове значення параметру:
```
http://<webmail>/src/read_body.php?mailbox=&passed_id=46106&startMessage=1
```

Замінити значення випадковим значенням:
```
http://<webmail>/src/read_body.php?mailbox=NOTEXIST&passed_id=46106&startMessage=1
```

Додати інші значення до параметра:
```
http://<webmail>/src/read_body.php?mailbox=INBOX PARAMETER2&passed_id=46106&startMessage=1
```

Додати нестандартні спеціальні символи (тобто: \, ', ", @, #, !, |):
```
http://<webmail>/src/read_body.php?mailbox=INBOX"&passed_id=46106&startMessage=1
```

Видалити параметр:
```
http://<webmail>/src/read_body.php?passed_id=46106&startMessage=1
```

Кінцевий результат вищенаведеного тестування дає тестувальнику три можливі ситуації:
- S1 - Додаток повертає код/повідомлення про помилку
- S2 - Додаток не повертає код/повідомлення про помилку, але не виконує запитувану операцію
- S3 - Додаток не повертає код/повідомлення про помилку і нормально виконує запитувану операцію

Ситуації S1 і S2 представляють успішну IMAP/SMTP ін'єкцію.

Метою зловмисника є отримання відповіді S1, оскільки це індикатор того, що додаток вразливий до ін'єкції та подальших маніпуляцій.

Припустимо, що користувач отримує заголовки електронної пошти, використовуючи наступний HTTP-запит:

```
http://<webmail>/src/view_header.php?mailbox=INBOX&passed_id=46105&passed_ent_id=0
```

Зловмисник може змінити значення параметра INBOX, впроваджуючи символ " (%22 використовуючи URL-кодування):

```
http://<webmail>/src/view_header.php?mailbox=INBOX%22&passed_id=46105&passed_ent_id=0
```

У цьому випадку відповідь додатка може бути:

```
ERROR: Bad or malformed request.
Query: SELECT "INBOX""
Server responded: Unexpected extra arguments to Select
```

Ситуацію S2 складніше успішно протестувати. Тестувальник повинен використовувати сліпу ін'єкцію команд, щоб визначити, чи вразливий сервер.

З іншого боку, остання ситуація (S3) не є релевантною в цьому параграфі.

**Список вразливих параметрів**

**Уражена функціональність**

**Тип можливої ін'єкції (IMAP/SMTP)**

### Розуміння потоку даних та структури розгортання клієнта

Після ідентифікації всіх вразливих параметрів (наприклад, passed_id), тестувальник повинен визначити, який рівень ін'єкції можливий, а потім розробити план тестування для подальшої експлуатації додатка.

У цьому тестовому випадку ми виявили, що параметр passed_id додатка є вразливим і використовується в наступному запиті:

```
http://<webmail>/src/read_body.php?mailbox=INBOX&passed_id=46225&startMessage=1
```

Використовуючи наступний тестовий випадок (надаючи алфавітне значення, коли потрібне числове значення):

```
http://<webmail>/src/read_body.php?mailbox=INBOX&passed_id=test&startMessage=1
```

згенерує наступне повідомлення про помилку:

```
ERROR : Bad or malformed request.
Query: FETCH test:test BODY[HEADER]
Server responded: Error in IMAP command received by server.
```

У цьому прикладі повідомлення про помилку повернуло назву виконаної команди та відповідні параметри.

В інших ситуаціях повідомлення про помилку (не контрольоване додатком) містить назву виконаної команди, але читання відповідного RFC дозволяє тестувальнику зрозуміти, які інші можливі команди можуть бути виконані.

Якщо додаток не повертає описові повідомлення про помилки, тестувальник повинен проаналізувати уражену функціональність, щоб вивести всі можливі команди (та параметри), пов'язані з вищезгаданою функціональністю. Наприклад, якщо вразливий параметр був виявлений у функціональності створення поштової скриньки, логічно припустити, що уражена команда IMAP - це CREATE. Згідно з RFC, команда CREATE приймає один параметр, який визначає ім'я поштової скриньки для створення.

**Список уражених команд IMAP/SMTP**

**Тип, значення та кількість параметрів, очікуваних ураженими командами IMAP/SMTP**

### IMAP/SMTP ін'єкція команд

Як тільки тестувальник ідентифікував вразливі параметри та проаналізував контекст, у якому вони виконуються, наступним етапом є експлуатація функціональності.

Цей етап має два можливі результати:

- Ін'єкція можлива в неавтентифікованому стані: уражена функціональність не вимагає автентифікації користувача. Доступні впроваджені (IMAP) команди обмежені: CAPABILITY, NOOP, AUTHENTICATE, LOGIN та LOGOUT.
- Ін'єкція можлива лише в автентифікованому стані: успішна експлуатація вимагає повної автентифікації користувача перед продовженням тестування.

У будь-якому випадку типова структура IMAP/SMTP ін'єкції така:

- **Заголовок**: закінчення очікуваної команди;
- **Тіло**: впровадження нової команди;
- **Нижній колонтитул**: початок очікуваної команди.

Важливо пам'ятати, що для виконання команди IMAP/SMTP попередня команда повинна бути завершена послідовністю CRLF (%0d%0a).

Припустимо, що на етапі ідентифікації вразливих параметрів зловмисник виявляє, що параметр message_id у наступному запиті є вразливим:

```
http://<webmail>/read_email.php?message_id=4791
```

Припустимо також, що результат аналізу, виконаного на етапі 2 ("Розуміння потоку даних та структури розгортання клієнта"), ідентифікував команду та аргументи, пов'язані з цим параметром, як:

```
FETCH 4791 BODY[HEADER]
```

У цьому сценарії структура IMAP ін'єкції буде:

```
http://<webmail>/read_email.php?message_id=4791 BODY[HEADER]%0d%0aV100 CAPABILITY%0d%0aV101 FETCH 4791
```

Що згенерує наступні команди:

```
???? FETCH 4791 BODY[HEADER]
V100 CAPABILITY
V101 FETCH 4791 BODY[HEADER]
```

де:

- Header = 4791 BODY[HEADER]
- Body = %0d%0aV100 CAPABILITY%0d%0a
- Footer = V101 FETCH 4791