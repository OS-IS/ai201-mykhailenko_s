# 4.7.9 Тестування ін'єкції XPath (WSTG-INPV-09)

## Резюме
XPath - це мова, яка була розроблена і створена в першу чергу для адресації частин XML-документа. При тестуванні ін'єкції XPath ми перевіряємо, чи можливо ін'єктувати синтаксис XPath у запит, який інтерпретується додатком, дозволяючи зловмиснику виконувати контрольовані користувачем XPath-запити. При успішній експлуатації ця вразливість може дозволити зловмиснику обійти механізми автентифікації або отримати доступ до інформації без належної авторизації.

Веб-додатки активно використовують бази даних для зберігання та доступу до даних, необхідних для їх роботи. Історично реляційні бази даних були найбільш поширеною технологією зберігання даних, але в останні роки ми спостерігаємо зростання популярності баз даних, які організовують дані за допомогою мови XML. Так само як реляційні бази даних доступні через мову SQL, XML-бази даних використовують XPath як стандартну мову запитів.

Оскільки з концептуальної точки зору XPath дуже схожий на SQL за своїм призначенням і застосуванням, цікавим результатом є те, що атаки ін'єкції XPath слідують тій же логіці, що і атаки SQL-ін'єкції. В деяких аспектах XPath є навіть більш потужним, ніж стандартний SQL, оскільки вся його потужність вже присутня в його специфікаціях, тоді як велика кількість технік, які можуть бути використані в атаці SQL-ін'єкції, залежать від характеристик SQL-діалекту, використовуваного цільовою базою даних. Це означає, що атаки ін'єкції XPath можуть бути набагато більш адаптованими і повсюдними. Іншою перевагою атаки ін'єкції XPath є те, що, на відміну від SQL, жодні ACL не застосовуються, оскільки наш запит може отримати доступ до кожної частини XML-документа.

## Цілі тестування
- Виявити точки ін'єкції XPATH.

## Як тестувати
Шаблон атаки XPath був вперше опублікований Амітом Кляйном і дуже схожий на звичайну SQL-ін'єкцію. Щоб отримати перше розуміння проблеми, давайте уявимо сторінку входу, яка керує автентифікацією до додатка, в якому користувач повинен ввести своє ім'я користувача та пароль. Припустимо, що наша база даних представлена наступним XML-файлом:

```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<users>
    <user>
        <username>gandalf</username>
        <password>!c3</password>
        <account>admin</account>
    </user>
    <user>
        <username>Stefan0</username>
        <password>w1s3c</password>
        <account>guest</account>
    </user>
    <user>
        <username>tony</username>
        <password>Un6R34kb!e</password>
        <account>guest</account>
    </user>
</users>
```

XPath-запит, який повертає обліковий запис з ім'ям користувача "gandalf" і паролем "!c3", буде наступним:
`string(//user[username/text()='gandalf' and password/text()='!c3']/account/text())`

Якщо додаток не фільтрує належним чином користувацький ввід, тестувальник зможе ін'єктувати XPath-код і втрутитися в результат запиту. Наприклад, тестувальник може ввести наступні значення:
- Ім'я користувача: `' or '1' = '1`  
- Пароль: `' or '1' = '1`

Дивлячись на XPath-запит, ми маємо:
`string(//user[username/text()='' or '1' = '1' and password/text()='' or '1' = '1']/account/text())`

Як у звичайній атаці SQL-ін'єкції, ми створили запит, який завжди оцінюється як істинний, що означає, що додаток автентифікує користувача навіть без надання дійсного імені користувача або пароля.

## Посилання
- Amit Klein: "Blind XPath Injection"
- Специфікації XPath 1.0